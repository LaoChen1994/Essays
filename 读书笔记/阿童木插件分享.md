| Astrboy plugin/middlewares |      |      |
| -------------------------- | ---- | ---- |
| Apollox                    |      |      |
| Astroboy-view-nunjucks     |      |      |
| Youzan-dubbo               |      |      |
| Youzan-kvds                |      |      |
|                            |      |      |
|                            |      |      |
|                            |      |      |

想知道的点：

1. 基于koa做了什么事情
2. 概念 plugin config middleware loader
3. 流程，初始化做了哪些事情
4. 实现

# 阿童木插件分享

## 0. 今天帮你解决几个问题

1. 阿童木是怎么实现配置上的继承的？
2. 阿童木的service, controller，router都是啥,他的配置存在哪儿？
3. 阿童木的中间件的ignore和match配置同时存在谁的优先级更高

## 1. 阿童木的基础架构

### 1. 1 有赞的Node结构

![有赞 Node 技术地图 (4)](/Users/pidan/Desktop/分享/vue 3/有赞 Node 技术地图 (4).png)

### 1.1 架构图和插件

>  Astroyboy自己给的定义定义：Astroboy is a Nodejs SFB(Separation of Front and Back ends) framework, built on koa2.
>
> 基于Koa2的前后端分离的Node js 框架

![image-20210616001146935](/Users/pidan/Library/Application Support/typora-user-images/image-20210616001146935.png)

### 1.2 CoreLoader核心方法分析

**关键方法：**CoreLoader收集了所有相应的配置信息、插件信息

Q1: loader 和 Plugin的区别是什么

A1: 我的理解 -> loader是将对应的文件进行导入的一个东西，类比webpack的loader。比如我们经常通过this.config获取对应的配置，他就是通过configLoader来做的

![image-20210616002524654](/Users/pidan/Library/Application Support/typora-user-images/image-20210616002524654.png)

+ coreDirs -> 主要是extends后的App类

+ pluginConfig -> 用到的一些插件，astroboy-body, astroyboy-router等

  ![image-20210616002649580](/Users/pidan/Library/Application Support/typora-user-images/image-20210616002649580.png)

+ fullDirs -> 包括各种插件的地址

+ loader -> 一些载入的配置

  + loader的载入会先搞一个loadQueue根据loader.xxx.js中的loader的配置中的prioriy进行排序，

  + 优先级高的会先执行

    ![image-20210616005318336](/Users/pidan/Library/Application Support/typora-user-images/image-20210616005318336.png)

+ runLoad 没什么好说的就是批量创建loader对象，该往app上挂东西就挂东西

  ![image-20210616005506928](/Users/pidan/Library/Application Support/typora-user-images/image-20210616005506928.png)

  

### 1. 3 Loader是如何加载对应的配置的

正则匹配全局的文件

![image-20210616114918933](/Users/pidan/Library/Application Support/typora-user-images/image-20210616114918933.png)



### 1.3 Controller和Service到底是什么

他其实就是通过AstroyControllerLoader和AstroyServiceLoader往app上挂的一系列的对象和函数～！

**loader做的具体操作**

1. **从指定的目录中拉取配置**
2. **将对应的对象和函数挂载到app.service和app.controller上**

![image-20210616005734265](/Users/pidan/Library/Application Support/typora-user-images/image-20210616005734265.png)

![image-20210616005757793](/Users/pidan/Library/Application Support/typora-user-images/image-20210616005757793.png)

### 1.4 一起来康康阿童木的中间件

从源码中我们可以发现：

1. 我们写阿童木的中间件的时候其实需要写的是一个闭包呀～终于找到原因了，源码里面会给他做初始值的配置
2. match和ignore的优先级问题match > ignore
3. 

![image-20210616010255476](/Users/pidan/Library/Application Support/typora-user-images/image-20210616010255476.png)



